<!DOCTYPE html>
<html lang="en">

<head>
    <script type="importmap">{"imports":{"www/":"/"}}</script>
    <script type="module" src="/phloe.mjs"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phloemjs: Example website</title>
    <script src="/do-it-later--requestAnimationFrame.js"></script>
    <style>
        html,
        body {
            width: 100%;
            margin: 0;
            position: relative;
            scroll-behavior: smooth;
            font-family: Roboto, Noto Sans, Noto Sans JP, Noto Sans KR, Noto Naskh Arabic, Noto Sans Thai, Noto Sans Hebrew, Noto Sans Bengali, sans-serif;
            font-size: 12px;
            line-height: 1.4;
        }

        body {
            background-color: black;
            color: white;
        }

        .task-board {
            box-sizing: border-box;
            height: 100%;
        }

        #nav-factors-bar label {
            cursor: pointer;
            user-select: none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;
            border-radius: 3px;
            padding: 1em .5em;
            box-sizing: border-box;
            display: inline-block;
            padding: 0.25em 0.5em;
        }

        #nav-factors-bar label:hover {
            background-color: gray;
        }
    </style>
</head>

<body>
    <script>
        const DatabaseHandler = Object.assign(new EventTarget(), {
            tasks: {
                "1": { name: "Project Charter", assigned: "Leon W", progress: "", duration: 3600000, start: "3/12/18", end: "3/15/18" },
                "2": { name: "Project Charter Revisions", assigned: "Kylie R", progress: "", duration: 3600000, start: "3/15/18", end: "3/16/18" },
                "3": { name: "Research", assigned: "Pete S", progress: "", duration: 3600000, start: "3/15/18", end: "3/21/18" },
                "4": { name: "Projections", assigned: "Steve L", progress: "", duration: 3600000, start: "3/16/18", end: "3/22/18" },
                "5": { name: "Stakeholders", assigned: "Allen W", progress: "", duration: 3600000, start: "", end: "" },
                "6": { name: "Guidelines", assigned: "Malik M", progress: "", duration: 3600000, start: "", end: "" },
                "7": { name: "Project Initiation", assigned: "Malik M", progress: "", duration: 3600000, start: "", end: "" }
            },

            getTask: function (taskId) {
                return this.tasks[taskId]
            },

            updateTask: function (taskId, changes, mtime = (new Date()).getTime()) {
                const task = this.tasks[taskId]
                if (mtime <= task._mtime) return
                task._mtime = mtime

                var attr
                for (attr in changes)
                    if (task[attr] === changes[attr]) { delete changes[attr] }
                    else task[attr] = changes[attr]

                if (Object.keys(changes).length) this.dispatchTaskUpdate(taskId, changes)
            },

            // Event Handler
            dispatchTaskUpdate: function (taskId, changes) {
                this.dispatchEvent(new CustomEvent("task-update", {
                    detail: {
                        taskId: taskId,
                        changes: changes
                    },
                }))
            }

        })
    </script>
    <div>project-management-tool</div>
    <div>
        <ul>
            <li>Calendar view</li>
            <li>Task list (WBS) + Grantt chart</li>
            <li>Diagram</li>
            <li>Kanban</li>
        </ul>
    </div>
    <div id="grantt-view">
        <div id="nav-factors-bar">
            <div>
                <label><input type="checkbox" for-class="mode--show-task-name" name="mode--show-task-name" checked />Task name</label>
                <label><input type="checkbox" for-class="mode--show-assigned" name="mode--show-assigned" checked />Assigned</label>
                <label><input type="checkbox" for-class="mode--show-progress" name="mode--show-progress" />Progress</label>
                <label><input type="checkbox" for-class="mode--show-duration" name="mode--show-duration" />Duration</label>
                <label><input type="checkbox" for-class="mode--show-start" name="mode--show-start" />Start</label>
                <label><input type="checkbox" for-class="mode--show-end" name="mode--show-end" />End</label>
            </div>
            <div>
                <label><input type="checkbox" for-class="mode--show-grantt-chart" name="mode--show-grantt-chart" checked />Grantt Chart</label> [<input type="datetime-local" />-<input type="datetime-local" />]
            </div>
        </div>
        <style>
            #grantt-table {
                width: 100%;
                display: block;
                border: 1px solid;
            }

            #grantt-table progress {
                width: 4em;
            }

            #grantt-table input[type="text"] {
                background-color: rgba(0, 0, 0, 0);
                color: white;
                border: none;
                outline: none;
            }

            #grantt-table:not(.mode--show-task-name) tr>td:nth-child(2),
            #grantt-table:not(.mode--show-assigned) tr>td:nth-child(3),
            #grantt-table:not(.mode--show-progress) tr>td:nth-child(4),
            #grantt-table:not(.mode--show-duration) tr>td:nth-child(5),
            #grantt-table:not(.mode--show-start) tr>td:nth-child(6),
            #grantt-table:not(.mode--show-end) tr>td:nth-child(7),
            #grantt-table:not(.mode--show-grantt-chart) tr>td:nth-child(8) {
                display: none;
            }
        </style>
        <table id="grantt-table">
            <thead>
                <tr>
                    <td key="more-btn"></td>
                    <td key="name">Task name</td>
                    <td key="assigned">Assigned</td>
                    <td key="progress">Progress</td>
                    <td key="duration">Duration</td>
                    <td key="start">Start</td>
                    <td key="end">End</td>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <script>
            {
                const navElm = document.getElementById("nav-factors-bar"),
                    mainTableElm = document.getElementById("grantt-table"),
                    main_classList = mainTableElm.classList
                function _EL() {
                    main_classList[this.checked ? "add" : "remove"](this.getAttribute("for-class"))
                }
                navElm.querySelectorAll('input[type="checkbox"][for-class]').forEach(elm => {
                    if (elm.checked) main_classList.add(elm.getAttribute("for-class"))
                    elm.addEventListener("click", _EL)
                })

                const GranttTbodyCpms = {
                    "more-btn": {
                        sample: `<input type="button" value="" />`,
                        get: function (tag) { },
                        update: function (tag, changes) { }
                    },
                    "name": {
                        sample: `<input type="text">`,
                        update: function (tag, changes) { if (changes.hasOwnProperty("name")) DIL(tag, "value", changes.name) },
                        get: function (tag, out = {}) { out.name = tag.value }
                    },
                    "assigned": {
                        sample: `<div>ðŸ‘¤ðŸ‘¤</div>`,
                        update: function (tag, changes) { if (changes.hasOwnProperty("assigned")) DIL(tag, "innerText", changes.assigned) },
                        get: function (tag, out = {}) { out.assigned = tag.innerText }
                    },
                    "progress": {
                        sample: `<div><input type="button" value="" /><input type="range" min="0" max="100" step="1" value="0" /></div>`,
                        update: function (tag, changes) { if (changes.hasOwnProperty("progress")) DIL(tag.children[1], "value", changes.progress) },
                        get: function (tag, out = {}) { out.progress = tag.children[1].value }
                    },
                    "duration": {
                        sample: `<input type="time">`,
                        update: function (tag, changes) { if (changes.hasOwnProperty("duration")) DIL(tag, "value", changes.duration) },
                        get: function (tag, out = {}) { out.duration = tag.value }
                    },
                    "start": {
                        sample: `<input type="datetime-local">`,
                        update: function (tag, changes) { if (changes.hasOwnProperty("start")) DIL(tag, "value", changes.start) },
                        get: function (tag, out = {}) { out.start = tag.value }
                    },
                    "end": {
                        sample: `<input type="datetime-local">`,
                        update: function (tag, changes) { if (changes.hasOwnProperty("end")) DIL(tag, "value", changes.end) },
                        get: function (tag, out = {}) { out.end = tag.value }
                    }
                }

                const GranttTableHandler = window.GranttTableHandler = Object.assign(new EventTarget(), {
                    mainTableElm: mainTableElm,
                    tableHead: mainTableElm.querySelector("thead"),
                    tableBody: mainTableElm.querySelector("tbody"),

                    fieldKeys: [],
                    taskTrSampleInnerHtml: "",

                    granttStartTime: new Date(),
                    granttEndTime: new Date(),

                    generateTaskTr: function () {
                        const trElm = document.createElement("tr")
                        trElm.innerHTML = this.taskTrSampleInnerHtml
                        return trElm
                    },

                    addTaskTr: function (taskId, task) {
                        const elm = this.generateTaskTr()
                        elm.setAttribute("task-id", taskId)
                        this.updateTaskTr(elm, task)

                        DIL(this.tableBody, this.tableBody.appendChild, elm)
                    },

                    updateTaskTr: function (tag, changes) {
                        const _fieldKeys = this.fieldKeys;
                        [...tag.children].forEach((td, indx) => GranttTbodyCpms[_fieldKeys[indx]].update(td.firstChild, changes))
                    },


                    addTask: function (taskId, task) {
                        this.addTaskTr(taskId, task)
                    },

                    updateTask: function (taskId, changes) {
                        this.updateTaskTr(this.tableBody.querySelector(`tr[task-id="${taskId}"]`), changes)
                    },


                    // Event Handler
                    dispatchTaskUpdate: function (taskId, changes) {
                        this.dispatchEvent(new CustomEvent("task-update", {
                            detail: {
                                taskId: taskId,
                                changes: changes
                            }
                        }))
                    },

                    init: function () {
                        this.fieldKeys = [...this.tableHead.children[0].children].map(elm => (elm.getAttribute && elm.getAttribute("key")) || undefined)
                        this.taskTrSampleInnerHtml = this.fieldKeys.map(key => "<td>" + GranttTbodyCpms[key].sample + "</td>").join("")

                        const _this = this
                        this.tableBody.addEventListener("change", function (e) {
                            var elm = e.target
                            const paths = [elm]
                            while ((elm = elm.parentElement) && elm !== this) paths.push(elm)
                            paths.reverse()

                            const changes = {}
                            GranttTbodyCpms[_this.fieldKeys[[...paths[0].children].indexOf(paths[1])]].get(paths[2], changes)
                            _this.dispatchTaskUpdate(paths[0].getAttribute("task-id"), changes)
                        })
                    }

                })

                GranttTableHandler.init()

                // Bind with DatabaseHandler
                GranttTableHandler.addEventListener("task-update", function (e) {
                    DatabaseHandler.updateTask(e.detail.taskId, e.detail.changes, e.timeStamp)
                })

                DatabaseHandler.addEventListener("task-update", function (e) {
                    GranttTableHandler.updateTask(e.detail.taskId, e.detail.changes, e.timeStamp)
                })

                Object.entries(DatabaseHandler.tasks).forEach(([key, task]) => GranttTableHandler.addTask(key, task))
            }
        </script>
    </div>
</body>

</html>