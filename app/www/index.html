<!DOCTYPE html>
<html lang="en">

<head>
    <script type="importmap">{"imports":{"www/":"/"}}</script>
    <script type="module" src="/phloe.mjs"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phloemjs: Example website</title>
    <script src="/do-it-later--requestAnimationFrame.js"></script>
    <style>
        html,
        body {
            width: 100%;
            margin: 0;
            position: relative;
            scroll-behavior: smooth;
            font-family: Roboto, Noto Sans, Noto Sans JP, Noto Sans KR, Noto Naskh Arabic, Noto Sans Thai, Noto Sans Hebrew, Noto Sans Bengali, sans-serif;
            font-size: 12px;
            line-height: 1.4;
        }

        body {
            background-color: black;
            color: white;
        }

        .task-board {
            box-sizing: border-box;
            height: 100%;
        }

        #nav-factors-bar label {
            cursor: pointer;
            user-select: none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;
            border-radius: 3px;
            padding: 1em .5em;
            box-sizing: border-box;
            display: inline-block;
            padding: 0.25em 0.5em;
        }

        #nav-factors-bar label:hover {
            background-color: gray;
        }
    </style>
    <script>

        const cpmBuilders = {
            inputTime: {
                textRe: /([+-]?\d+(\.\d*)?|\.\d+)\s*((ms)|(s|''|")|(m|')|(h)|(d)|(M)|(Y|y))?/g,
                timeMsFromText: function (text) {
                    const re = this.textRe; re.lastIndex = 0
                    var timeMs = 0, rs; while (rs = re.exec(text)) timeMs += parseFloat(rs[1]) * (rs[4] ? 1 : rs[5] ? 1000 : rs[6] ? 60000 : rs[7] ? 3600000 : rs[8] ? 86400000 : rs[9] ? 2592000000 : rs[10] ? 31104000000 : 1)
                    return timeMs
                },
                textFromTimeMs: function (timeMs) {
                    var text = [], n = parseFloat(timeMs), b, i, r

                    r = n % 31104000000
                    i = (n - r) / 31104000000
                    if (i !== 0) text.push(i + "Y")
                    n = r

                    r = n % 2592000000
                    i = (n - r) / 2592000000
                    if (i !== 0) text.push(i + "M")
                    n = r

                    r = n % 86400000
                    i = (n - r) / 86400000
                    if (i !== 0) text.push(i + "d")
                    n = r

                    r = n % 3600000
                    i = (n - r) / 3600000
                    if (i !== 0) text.push(i + "h")
                    n = r

                    r = n % 60000
                    i = (n - r) / 60000
                    if (i !== 0) text.push(i + "m")
                    n = r

                    r = n % 1000
                    i = (n - r) / 1000
                    if (i !== 0) text.push(i + "s")
                    n = r

                    i = n
                    if (i !== 0) text.push(i + "ms")

                    return text.join(" ")
                },
                createElement: function () {
                    const elm = document.createElement("input")
                    elm.type = "text"
                    elm.addEventListener("change", this._changeEL)
                    elm._builder = this
                    return elm
                },
                _changeEL: function (e) {
                    const elm = e.target,
                        inputValue = elm.value,
                        timeMs = this._builder.timeMsFromText(inputValue),
                        text = this._builder.textFromTimeMs(this.timeMs = timeMs)

                    if (elm.timeMs == timeMs) e.stopPropagation()
                    elm.timeMs = timeMs
                    if (elm.value !== text) DIL(elm, "value", text)
                }
            },
        }

    </script>
</head>

<body>
    <div id="test-zone" style="padding: 2em;">
        <div id="test">
            <span class="time-from">2023-12-29 15:30:20.001</span> [ <span class="time-duration">1Y 2M 3d 5h 4m 3s 12ms</span> ] <span class="time-to">2023-12-29 15:30:20.001</span>
        </div>
        <div>
            <span class="time-from">2023-12-29 15:30</span> [ <span class="time-duration">3d 5h 4m</span> ] <span class="time-to">2023-12-29 15:30</span>
        </div>
    </div>
    <script>
        const CORE = Object.assign(new EventTarget(), {
            timezoneOffset: undefined,
            setTimezoneOffset: function (offfset) {
                if (this.timezoneOffset === offfset) return
                this.timezoneOffset = offfset
                this.dispatchEvent(new Event("change-timezone-offset"))
            }
        })
        CORE.setTimezoneOffset(-new Date().getTimezoneOffset())

        function isObject(obj) { return obj === Object(obj) }
        function deepAssign(src, dst, diff = {}) {
            var k, S, D; for (k in src) {
                D = dst[k]
                if (isObject(S = src[k]) && isObject(D)) {
                    if (!deepAssign(S, D, diff[k] = {})) delete diff[k]
                }
                else if (D !== S) diff[k] = dst[k] = S
            }
            return Object.keys(diff).length ? diff : null
        }

        const DatabaseHandler = Object.assign(new EventTarget(), {
            data: {},
            assign: function (src) {
                const diff = deepAssign(src, this.data)
                if (diff) this.dispatchEvent(new CustomEvent("change", { detail: diff }))
            }
        })

        window.addEventListener("load", function (e) {
            DatabaseHandler.assign({
                tasks: {
                    "1": { name: "Project Charter", assigned: "Leon W", progress: Math.round(Math.random() * 100), plan: { from: 1702031000017, to: 1703240600017 }, track: { from: 1702031000017, to: 1703240600017 } },
                    "2": { name: "Project Charter Revisions", assigned: "Kylie R", progress: Math.round(Math.random() * 100) },
                    "3": { name: "Research", assigned: "Pete S", progress: Math.round(Math.random() * 100) },
                    "4": { name: "Projections", assigned: "Steve L", progress: Math.round(Math.random() * 100) },
                    "5": { name: "Stakeholders", assigned: "Allen W", progress: Math.round(Math.random() * 100) },
                    "6": { name: "Guidelines", assigned: "Malik M", progress: Math.round(Math.random() * 100) },
                    "7": { name: "Project Initiation", assigned: "Malik M", progress: Math.round(Math.random() * 100) }
                }
            })
        }, { once: true })
    </script>
    <div>project-management-tool</div>
    <div>
        <ul>
            <li>Calendar view</li>
            <li>Task list (WBS) + Grantt chart</li>
            <li>Diagram</li>
            <li>Kanban</li>
        </ul>
    </div>
    <div id="grantt-view">
        <div id="nav-factors-bar">
            <div>
                <label><input type="checkbox" for-class="mode--show-name" name="mode--show-name" checked />Task name</label>
                <label><input type="checkbox" for-class="mode--show-assigned" name="mode--show-assigned" checked />Assigned</label>
                <label><input type="checkbox" for-class="mode--show-progress" name="mode--show-progress" />Progress</label>
            </div>
            <table>
                <tr>
                    <td>Track:</td>
                    <td>
                        <label><input type="checkbox" for-class="mode--show-duration" name="mode--show-duration" checked />Duration</label>
                    </td>
                    <td>
                        <label><input type="checkbox" for-class="mode--show-start" name="mode--show-start" />Start</label>
                    </td>
                    <td>
                        <label><input type="checkbox" for-class="mode--show-end" name="mode--show-end" />End</label>
                    </td>
                </tr>
                <tr>
                    <td>Plan:</td>
                    <td>
                        <label><input type="checkbox" for-class="mode--show-plan-duration" name="mode--show-plan-duration" checked />Duration</label>
                    </td>
                    <td>
                        <label><input type="checkbox" for-class="mode--show-plan-start" name="mode--show-plan-start" />Start</label>
                    </td>
                    <td>
                        <label><input type="checkbox" for-class="mode--show-plan-end" name="mode--show-plan-end" />End</label>
                    </td>
                </tr>
            </table>
            <div>
                <label><input type="checkbox" for-class="mode--show-grantt" name="mode--show-grantt" checked />Grantt Chart</label>[<input type="datetime-local" />-<input type="datetime-local" />]
            </div>
            <div>
                <label> Use timezone: <select id="timezone-selector" name="timezone-selector"></select></label> (Offfset: <input id="timezone-offfset" type="number" min="-720" max="840" style="text-align: right;">minutes)
                <script>
                    {
                        const elm = document.getElementById("timezone-selector");
                        ["UTC-12:00", "UTC-11:00", "UTC-10:00", "UTC-09:30", "UTC-09:00", "UTC-08:00", "UTC-07:00", "UTC-06:00", "UTC-05:00", "UTC-04:00", "UTC-03:30", "UTC-03:00", "UTC-02:00", "UTC-01:00", "UTCÂ±00:00", "UTC+01:00", "UTC+02:00", "UTC+03:00", "UTC+03:30", "UTC+04:00", "UTC+04:30", "UTC+05:00", "UTC+05:30", "UTC+05:45", "UTC+06:00", "UTC+06:30", "UTC+07:00", "UTC+08:00", "UTC+08:45", "UTC+09:00", "UTC+09:30", "UTC+10:00", "UTC+10:30", "UTC+11:00", "UTC+12:00", "UTC+12:45", "UTC+13:00", "UTC+14:00"].forEach(label => {
                            const offfset = (label.substring(3, 4) === "-" ? -1 : 1) * (parseInt(label.substring(4, 6) * 60) + parseInt(label.substring(7, 9)))
                            e = document.createElement("option")
                            e.value = offfset
                            e.innerText = label
                            elm.appendChild(e)
                        })

                        const offfsetElm = document.getElementById("timezone-offfset")
                        elm.addEventListener("change", function (e) {
                            offfsetElm.value = this.value
                            offfsetElm.dispatchEvent(new Event('change'))
                        })
                        offfsetElm.addEventListener("change", function (e) {
                            CORE.setTimezoneOffset(elm.value = this.value)
                        })
                        CORE.addEventListener("change-timezone-offset", function (e) {
                            if (offfsetElm.value === this.timezoneOffset) return
                            offfsetElm.value = this.timezoneOffset
                            offfsetElm.dispatchEvent(new Event('change', { 'bubbles': true }))
                        })

                        offfsetElm.value = CORE.timezoneOffset
                        offfsetElm.dispatchEvent(new Event('change', { 'bubbles': true }))
                    }
                </script>
            </div>
        </div>
        <style>
            #grantt-table progress {
                width: 4em;
            }

            #grantt-table input[type="text"] {
                background-color: rgba(0, 0, 0, 0);
                color: white;
                border: none;
                outline: none;
            }

            table#grantt-table>thead>*>* {
                text-align: left;
                white-space: nowrap;
                overflow: hidden;
                width: fit-content;
            }

            table#grantt-table:not(.mode--show-name)>*>*>*:nth-child(2),
            table#grantt-table:not(.mode--show-assigned)>*>*>*:nth-child(3),
            table#grantt-table:not(.mode--show-progress)>*>*>*:nth-child(4),
            table#grantt-table:not(.mode--show-start)>*>*>*:nth-child(5),
            table#grantt-table:not(.mode--show-duration)>*>*>*:nth-child(6),
            table#grantt-table:not(.mode--show-end)>*>*>*:nth-child(7),
            table#grantt-table:not(.mode--show-plan-start)>*>*>*:nth-child(8),
            table#grantt-table:not(.mode--show-plan-duration)>*>*>*:nth-child(9),
            table#grantt-table:not(.mode--show-plan-end)>*>*>*:nth-child(10),
            table#grantt-table:not(.mode--show-grantt)>*>*>*:nth-child(11) {
                display: none;
            }

            table#grantt-table>tbody>tr>td>* {
                width: 100%;
                white-space: nowrap;
            }

            table#grantt-table input[type="datetime-local" i] {
                width: fit-content !important;
            }

            #grantt-table>tbody>tr>td:nth-child(11)>* {
                background-color: blue;
                transition: margin-left 100ms;
                transition: width 100ms;
                white-space: nowrap;
            }
        </style>
        <table id="grantt-table" class="mode--show-name mode--show-assigned mode--show-grantt" style="width: 100%;">
            <thead>
                <tr>
                    <th key="more" style="width: 1em;"></th>
                    <th key="name">Task name</th>
                    <th key="assigned">Assigned</th>
                    <th key="progress" style="width: 0;">Progress</th>
                    <th key="start" style="width: 0;">Start</th>
                    <th key="duration" style="width: 5em;">Duration</th>
                    <th key="end" style="width: 0;">End</th>
                    <th key="plan-start" style="width: 0;">Plan Start</th>
                    <th key="plan-duration" style="width: 5em;">Plan Duration</th>
                    <th key="plan-end" style="width: 0;">Plan End</th>
                    <th key="grantt">Grantt</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <script>
            {
                const navElm = document.getElementById("nav-factors-bar"),
                    mainTableElm = document.getElementById("grantt-table"),
                    main_classList = mainTableElm.classList
                function _EL() {
                    main_classList[this.checked ? "add" : "remove"](this.getAttribute("for-class"))
                }
                navElm.querySelectorAll('input[type="checkbox"][for-class]').forEach(elm => {
                    if (elm.checked) main_classList.add(elm.getAttribute("for-class"))
                    elm.addEventListener("click", _EL)
                })

                const _dispatchTaskChange = function (elm, taskDiff) {
                    elm.dispatchEvent(new CustomEvent("task-change", {
                        bubbles: true,
                        detail: taskDiff
                    }))
                }
                const GranttTbodyCpms = {
                    "more": {
                        createElement: function () {
                            const elm = document.createElement("input")
                            elm.type = "button"
                            return elm
                        }
                    },
                    "name": {
                        createElement: function () {
                            const elm = document.createElement("input")
                            elm.type = "text"
                            elm.addEventListener("change", this._EL)
                            return elm
                        },
                        _EL: function (e) {
                            e.stopPropagation()
                            _dispatchTaskChange(e.target, { name: e.target.value })
                        },
                        update: function (elm, changes) { if (changes.hasOwnProperty("name")) DIL(elm, "value", changes.name) }
                    },
                    "assigned": {
                        createElement: function () {
                            const elm = document.createElement("div")
                            elm.innerText = "ðŸ‘¤ðŸ‘¤"
                            return elm
                        }
                    },
                    "progress": {
                        createElement: function () {
                            const elm = document.createElement("div"),
                                input1 = document.createElement("input"),
                                input2 = document.createElement("input")

                            input1.type = "button"
                            input2.type = "range"
                            input2.min = 0
                            input2.max = 100
                            input2.step = 1
                            input2.value = 0
                            elm.appendChild(input1)
                            elm.appendChild(input2)

                            input2.addEventListener("change", this._EL)
                            return elm
                        },
                        _EL: function (e) {
                            e.stopPropagation()
                            _dispatchTaskChange(e.target, { progress: e.target.value })
                        },
                        update: function (elm, changes) { if (changes.hasOwnProperty("progress")) DIL(elm.children[1], "value", changes.progress) }
                    },
                    "duration": {
                        createElement: function () {
                            const elm = cpmBuilders.inputTime.createElement()
                            elm.addEventListener("change", this._EL)
                            return elm
                        },
                        _EL: function (e) {
                            e.stopPropagation()
                            _dispatchTaskChange(e.target, { duration: e.target.timeMs })
                        },
                        update: function (elm, changes) {
                            if (changes.hasOwnProperty("duration")) {
                                DIL(elm, "value", changes.duration)
                                DIL(elm, elm.dispatchEvent, new Event('change', { 'bubbles': true }))
                            }
                        }
                    },
                    "start": {
                        createElement: function () {
                            const elm = document.createElement("input")
                            elm.type = "datetime-local"
                            return elm
                        },
                        update: function (elm, changes) { if (changes.hasOwnProperty("start")) DIL(elm, "value", changes.start) }
                    },
                    "end": {
                        createElement: function () {
                            const elm = document.createElement("input")
                            elm.type = "datetime-local"
                            return elm
                        },
                        update: function (elm, changes) { if (changes.hasOwnProperty("end")) DIL(elm, "value", changes.end) }
                    },
                    "plan-duration": {
                        createElement: function () {
                            const elm = cpmBuilders.inputTime.createElement()
                            elm.addEventListener("change", this._EL)
                            return elm
                        },
                        _EL: function (e) {
                            e.stopPropagation()
                            _dispatchTaskChange(e.target, { planDuration: e.target.timeMs })
                        },
                        update: function (elm, changes) {
                            if (changes.hasOwnProperty("planDuration")) {
                                DIL(elm, "value", changes.planDuration)
                                DIL(elm, elm.dispatchEvent, new Event('change', { 'bubbles': true }))
                            }
                        }
                    },
                    "grantt": {
                        createElement: function () {
                            const elm = document.createElement("div")
                            elm.innerText = "xxx"
                            return elm
                        },
                        update: function (elm, changes) {
                            // #TODO:
                            // console.log("c", changes);
                            const start = Math.round(Math.random() * 100)
                            if (changes.hasOwnProperty("name")) DIL(elm, "innerText", changes.name)
                            if (!elm.style.marginLeft) elm.style.marginLeft = start + "%";
                            if (!elm.style.width) elm.style.width = Math.round(Math.random() * (100 - start)) + "%";
                        }
                    }
                }

                const GranttTableHandler = window.GranttTableHandler = Object.assign(new EventTarget(), {
                    mainTableElm: mainTableElm,
                    tableHead: mainTableElm.querySelector("thead"),
                    tableBody: mainTableElm.querySelector("tbody"),
                    fieldKeys: [],

                    generateTaskTr: function (taskId) {
                        const trElm = document.createElement("tr")
                        trElm.setAttribute("task-id", taskId)
                        this.fieldKeys.map(key => {
                            const elm = document.createElement("td"), cpm = GranttTbodyCpms[key]
                            if (cpm && cpm.createElement) elm.appendChild(cpm.createElement())
                            return elm
                        }).forEach(trElm.appendChild, trElm)
                        return trElm
                    },

                    assignTaskTr: function (elm, changes) {
                        _fieldKeys = this.fieldKeys;
                        [...elm.children].forEach((td, indx) => {
                            const cpm = GranttTbodyCpms[_fieldKeys[indx]], fn = cpm && cpm.update
                            if (fn) fn(td.firstChild, changes)
                        })
                    },

                    getTaskTr: function (taskId) {
                        return this.tableBody.querySelector(`tr[task-id="${taskId}"]`)
                    },

                    assignTask: function (taskId, taskDiff) {
                        const trElm = this.getTaskTr(taskId)
                        if (trElm) this.assignTaskTr(trElm, taskDiff)
                    },

                    assign: function (changes) {
                        Object.entries(changes.tasks).forEach(function ([taskId, taskDiff]) {
                            this.assignTask(taskId, taskDiff)
                        }, this)
                    },

                    addOrAssignTaskTr: function (taskId, task) {
                        var trElm = this.getTaskTr(taskId), taskTrExists = trElm
                        if (!taskTrExists) trElm = this.generateTaskTr(taskId)
                        this.assignTaskTr(trElm, task)
                        if (!taskTrExists) DIL(this.tableBody, this.tableBody.appendChild, trElm)
                    },

                    loadTasks: function (tasks) {
                        Object.entries(tasks).forEach(function ([taskId, task]) { this.addOrAssignTaskTr(taskId, task) }, this)
                    },

                    init: function () {
                        const _this = this
                        this.fieldKeys = [...this.tableHead.children[0].children].map(elm => (elm.getAttribute && elm.getAttribute("key")) || undefined)

                        this.tableBody.addEventListener("task-change", function (e) {
                            var elm = e.target, pElm; while ((pElm = elm.parentElement) !== this) elm = pElm
                            _this.dispatchEvent(new CustomEvent("change", {
                                detail: {
                                    tasks: {
                                        [elm.getAttribute("task-id")]: e.detail
                                    }
                                }
                            }))
                        })

                    }

                })

                GranttTableHandler.init()

                // Bind with DatabaseHandler
                GranttTableHandler.addEventListener("change", function (e) { DatabaseHandler.assign(e.detail) })
                DatabaseHandler.addEventListener("change", function (e) { GranttTableHandler.assign(e.detail) })
                // Load data
                window.addEventListener("load", function () {
                    GranttTableHandler.loadTasks(DatabaseHandler.data.tasks)
                }, { once: true })

            }
        </script>
    </div>
</body>

</html>