<!DOCTYPE html>
<html lang="en">

<head>
    <script type="importmap">{"imports":{"www/":"/"}}</script>
    <script type="module" src="/phloe.mjs"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phloemjs: Example website</title>
    <script src="/do-it-later--requestAnimationFrame.js"></script>
    <style>
        html,
        body {
            width: 100%;
            margin: 0;
            position: relative;
            scroll-behavior: smooth;
            font-family: Roboto, Noto Sans, Noto Sans JP, Noto Sans KR, Noto Naskh Arabic, Noto Sans Thai, Noto Sans Hebrew, Noto Sans Bengali, sans-serif;
            font-size: 12px;
            line-height: 1.4;
        }

        body {
            background-color: black;
            color: white;
        }

        .task-board {
            box-sizing: border-box;
            height: 100%;
        }

        #nav-factors-bar label {
            cursor: pointer;
            user-select: none;
            -moz-user-select: none;
            -khtml-user-select: none;
            -webkit-user-select: none;
            -o-user-select: none;
            border-radius: 3px;
            padding: 1em .5em;
            box-sizing: border-box;
            display: inline-block;
            padding: 0.25em 0.5em;
        }

        #nav-factors-bar label:hover {
            background-color: gray;
        }
    </style>
    <script>

        const cpmBuilders = {
            inputTime: function () {
                const elm = document.createElement("div")
                elm.innerText = "2023/12/19 06:35"
                return elm
            }
        }

    </script>
</head>

<body>
    <script>
        const DatabaseHandler = Object.assign(new EventTarget(), {
            tasks: {
                "1": { name: "Project Charter", assigned: "Leon W", progress: "", duration: 3600000, start: "3/12/18", end: "3/15/18" },
                "2": { name: "Project Charter Revisions", assigned: "Kylie R", progress: "", duration: 3600000, start: "3/15/18", end: "3/16/18" },
                "3": { name: "Research", assigned: "Pete S", progress: "", duration: 3600000, start: "3/15/18", end: "3/21/18" },
                "4": { name: "Projections", assigned: "Steve L", progress: "", duration: 3600000, start: "3/16/18", end: "3/22/18" },
                "5": { name: "Stakeholders", assigned: "Allen W", progress: "", duration: 3600000, start: "", end: "" },
                "6": { name: "Guidelines", assigned: "Malik M", progress: "", duration: 3600000, start: "", end: "" },
                "7": { name: "Project Initiation", assigned: "Malik M", progress: "", duration: 3600000, start: "", end: "" }
            },

            getTask: function (taskId) {
                return this.tasks[taskId]
            },

            updateTask: function (taskId, changes, mtime = (new Date()).getTime()) {
                const task = this.tasks[taskId]
                if (mtime <= task._mtime) return
                task._mtime = mtime

                var attr
                for (attr in changes)
                    if (task[attr] === changes[attr]) { delete changes[attr] }
                    else task[attr] = changes[attr]

                if (Object.keys(changes).length) this.dispatchTaskUpdate(taskId, changes)
            },

            // Event Handler
            dispatchTaskUpdate: function (taskId, changes) {
                this.dispatchEvent(new CustomEvent("task-update", {
                    detail: {
                        taskId: taskId,
                        changes: changes
                    },
                }))
            }

        })
    </script>
    <div>project-management-tool</div>
    <div>
        <ul>
            <li>Calendar view</li>
            <li>Task list (WBS) + Grantt chart</li>
            <li>Diagram</li>
            <li>Kanban</li>
        </ul>
    </div>
    <div id="grantt-view">
        <div id="nav-factors-bar">
            <div>
                <label><input type="checkbox" for-class="mode--show-name" name="mode--show-name" checked />Task name</label>
                <label><input type="checkbox" for-class="mode--show-assigned" name="mode--show-assigned" checked />Assigned</label>
                <label><input type="checkbox" for-class="mode--show-progress" name="mode--show-progress" />Progress</label>
                <label><input type="checkbox" for-class="mode--show-duration" name="mode--show-duration" />Duration</label>
                <label><input type="checkbox" for-class="mode--show-start" name="mode--show-start" />Start</label>
                <label><input type="checkbox" for-class="mode--show-end" name="mode--show-end" />End</label>
                <label><input type="checkbox" for-class="mode--show-grantt" name="mode--show-grantt" checked />Grantt Chart</label>
            </div>
        </div>
        <style>
            #grantt-table progress {
                width: 4em;
            }

            #grantt-table input[type="text"] {
                background-color: rgba(0, 0, 0, 0);
                color: white;
                border: none;
                outline: none;
            }

            table#grantt-table>thead>*>* {
                text-align: left;
                white-space: nowrap;
                overflow: hidden;
            }

            table#grantt-table:not(.mode--show-name)>*>*>*:nth-child(2),
            table#grantt-table:not(.mode--show-assigned)>*>*>*:nth-child(3),
            table#grantt-table:not(.mode--show-progress)>*>*>*:nth-child(4),
            table#grantt-table:not(.mode--show-duration)>*>*>*:nth-child(5),
            table#grantt-table:not(.mode--show-start)>*>*>*:nth-child(6),
            table#grantt-table:not(.mode--show-end)>*>*>*:nth-child(7),
            table#grantt-table:not(.mode--show-grantt)>*>*>*:nth-child(8) {
                display: none;
            }

            #grantt-table>tbody>tr>td:nth-child(8)>* {
                background-color: blue;
                transition: margin-left 100ms;
                transition: width 100ms;
            }
        </style>
        <table id="grantt-table" class="mode--show-name mode--show-assigned mode--show-grantt" style="width: 100%;">
            <thead>
                <tr>
                    <th key="more"></th>
                    <th key="name">Task name</th>
                    <th key="assigned">Assigned</th>
                    <th key="progress">Progress</th>
                    <th key="duration">Duration</th>
                    <th key="start">Start</th>
                    <th key="end">End</th>
                    <th key="grantt">Grantt [<input type="datetime-local" />-<input type="datetime-local" />]</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <script>
            {
                const navElm = document.getElementById("nav-factors-bar"),
                    mainTableElm = document.getElementById("grantt-table"),
                    main_classList = mainTableElm.classList
                function _EL() {
                    main_classList[this.checked ? "add" : "remove"](this.getAttribute("for-class"))
                }
                navElm.querySelectorAll('input[type="checkbox"][for-class]').forEach(elm => {
                    if (elm.checked) main_classList.add(elm.getAttribute("for-class"))
                    elm.addEventListener("click", _EL)
                })

                const GranttTbodyCpms = {
                    "more": {
                        createElement: function () {
                            const elm = document.createElement("input")
                            elm.type = "button"
                            return elm
                        },
                        get: function (tag) { },
                        update: function (tag, changes) { }
                    },
                    "name": {
                        createElement: function () {
                            const elm = document.createElement("input")
                            elm.type = "text"
                            return elm
                        },
                        update: function (tag, changes) { if (changes.hasOwnProperty("name")) DIL(tag, "value", changes.name) },
                        get: function (tag, out = {}) { out.name = tag.value }
                    },
                    "assigned": {
                        createElement: function () {
                            const elm = document.createElement("div")
                            elm.innerText = "ðŸ‘¤ðŸ‘¤"
                            return elm
                        },
                        update: function (tag, changes) { if (changes.hasOwnProperty("assigned")) DIL(tag, "innerText", changes.assigned) },
                        get: function (tag, out = {}) { out.assigned = tag.innerText }
                    },
                    "progress": {
                        createElement: function () {
                            const elm = document.createElement("div"),
                                input1 = document.createElement("input"),
                                input2 = document.createElement("input")

                            input1.type = "button"
                            input2.type = "range"
                            input2.min = 0
                            input2.max = 100
                            input2.step = 1
                            input2.value = 0
                            elm.appendChild(input1)
                            elm.appendChild(input2)

                            return elm
                        },
                        update: function (tag, changes) { if (changes.hasOwnProperty("progress")) DIL(tag.children[1], "value", changes.progress) },
                        get: function (tag, out = {}) { out.progress = tag.children[1].value }
                    },
                    "duration": {
                        createElement: function () {
                            const elm = document.createElement("input")
                            elm.type = "time"
                            return elm
                        },
                        update: function (tag, changes) { if (changes.hasOwnProperty("duration")) DIL(tag, "value", changes.duration) },
                        get: function (tag, out = {}) { out.duration = tag.value }
                    },
                    "start": {
                        createElement: function () {
                            const elm = document.createElement("input")
                            elm.type = "datetime-local"
                            return elm
                        },
                        update: function (tag, changes) { if (changes.hasOwnProperty("start")) DIL(tag, "value", changes.start) },
                        get: function (tag, out = {}) { out.start = tag.value }
                    },
                    "end": {
                        createElement: function () {
                            const elm = document.createElement("input")
                            elm.type = "datetime-local"
                            return elm
                        },
                        update: function (tag, changes) { if (changes.hasOwnProperty("end")) DIL(tag, "value", changes.end) },
                        get: function (tag, out = {}) { out.end = tag.value }
                    },
                    "grantt": {
                        createElement: function () {
                            const elm = document.createElement("div")
                            elm.innerText = "xxx"
                            return elm
                        },
                        update: function (tag, changes) {
                            // #TODO:
                            const start = Math.round(Math.random() * 100)
                            tag.style.marginLeft = start + "%";
                            tag.style.width = Math.round(Math.random() * (100 - start)) + "%";
                        },
                        get: function (tag, out = {}) { out.end = tag.value }
                    }
                }

                const GranttTableHandler = window.GranttTableHandler = Object.assign(new EventTarget(), {

                    // Table
                    mainTableElm: mainTableElm,
                    tableHead: mainTableElm.querySelector("thead"),
                    tableBody: mainTableElm.querySelector("tbody"),

                    fieldKeys: [],

                    generateTaskTr: function () {
                        const trElm = document.createElement("tr")
                        this.fieldKeys.map(key => {
                            const elm = document.createElement("td")
                            elm.appendChild(GranttTbodyCpms[key].createElement())
                            return elm
                        }).forEach(trElm.appendChild, trElm)
                        return trElm
                    },

                    updateTaskTag: function (tag, changes) {
                        _fieldKeys = this.fieldKeys;
                        [...tag.children].forEach((td, indx) => GranttTbodyCpms[_fieldKeys[indx]].update(td.firstChild, changes))
                    },

                    addTask: function (taskId, task) {
                        const elm = this.generateTaskTr()
                        elm.setAttribute("task-id", taskId)
                        this.updateTaskTag(elm, task)

                        DIL(this.tableBody, this.tableBody.appendChild, elm)
                    },

                    updateTask: function (taskId, changes) {
                        this.updateTaskTag(this.tableBody.querySelector(`tr[task-id="${taskId}"]`), changes)
                    },

                    // Event Handler
                    dispatchTaskUpdate: function (taskId, changes) {
                        this.dispatchEvent(new CustomEvent("task-update", {
                            detail: {
                                taskId: taskId,
                                changes: changes
                            }
                        }))
                    },

                    init: function () {
                        this.fieldKeys = [...this.tableHead.children[0].children].map(elm => (elm.getAttribute && elm.getAttribute("key")) || undefined)

                        const _this = this
                        this.tableBody.addEventListener("change", function (e) {
                            var elm = e.target
                            const paths = [elm]
                            while ((elm = elm.parentElement) && elm !== this) paths.push(elm)
                            paths.reverse()

                            const changes = {}
                            GranttTbodyCpms[_this.fieldKeys[[...paths[0].children].indexOf(paths[1])]].get(paths[2], changes)
                            _this.dispatchTaskUpdate(paths[0].getAttribute("task-id"), changes)
                        })
                    }

                })

                GranttTableHandler.init()

                // Bind with DatabaseHandler
                GranttTableHandler.addEventListener("task-update", function (e) {
                    DatabaseHandler.updateTask(e.detail.taskId, e.detail.changes, e.timeStamp)
                })
                DatabaseHandler.addEventListener("task-update", function (e) {
                    GranttTableHandler.updateTask(e.detail.taskId, e.detail.changes, e.timeStamp)
                })

                // Load data
                Object.entries(DatabaseHandler.tasks).forEach(([key, task]) => GranttTableHandler.addTask(key, task))
            }
        </script>
    </div>
</body>

</html>